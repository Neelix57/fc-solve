<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>
    <style>
      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      canvas.emscripten { border: 1px solid black; }
      textarea.emscripten { font-family: monospace; width: 80%; }
      div.emscripten { text-align: center; }
      .disabled { display: none; }
      #fc_solve_output {
            border: green 3pt solid;
            padding: 0.5em;
            background-color: #B0CFE1;
            overflow: scroll;
            height: 50em;
            width: 70em;
      }
  </style>
<!--
Please symlink or copy the libfreecell-solver.js as generated from
Makefile.to-javascript.mak to this directory.
-->

<script type="text/javascript" src="libfreecell-solver.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
</head>
  <body>
  <h1>Use Freecell Solver On the Web</h1>
    <hr/>
    <div class="disabled">
    <div class="emscripten" id="status">Downloading...</div>
    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    </div>
<strong>Input:</strong>
<textarea class="emscripten" id="stdin" rows="10"></textarea>
<button id="run_do_solve" onclick="javascript:do_solve()">Solve!</button>

    <hr/>
<div class="disabled">
    <div class="emscripten"><input type="button" value="fullscreen" onclick="Module.requestFullScreen()"></div>
    <hr/>
    <textarea class="emscripten" id="output" rows="8"></textarea>
</div>
<pre class="output" id="fc_solve_output">
</pre>
    <hr>
<script type="text/javascript">
 var entityMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': '&quot;',
    "'": '&#39;',
    "/": '&#x2F;'
  };

  function escapeHtml(string) {
    return String(string).replace(/[&<>"'\/]/g, function (s) {
      return entityMap[s];
    });
  }

var freecell_solver_user_alloc = Module.cwrap('freecell_solver_user_alloc', 'number', []);
var freecell_solver_user_solve_board = Module.cwrap('freecell_solver_user_solve_board', 'number', ['number', 'string']);
var freecell_solver_user_cmd_line_read_cmd_line_preset = Module.cwrap('freecell_solver_user_cmd_line_read_cmd_line_preset', 'number', ['number', 'string', 'number', 'number', 'number', 'string']);
var malloc = Module.cwrap('malloc', 'number', ['number']);
var freecell_solver_user_current_state_as_string = Module.cwrap('freecell_solver_user_current_state_as_string', 'string', ['number', 'number', 'number', 'number']);
var freecell_solver_user_get_next_move = Module.cwrap('freecell_solver_user_get_next_move', 'number', ['number', 'number']);
var freecell_solver_user_current_state_as_string = Module.cwrap('freecell_solver_user_current_state_as_string', 'string', ['number', 'number', 'number', 'number']);
var freecell_solver_user_move_ptr_to_string_w_state = Module.cwrap('freecell_solver_user_move_ptr_to_string_w_state', 'string', ['number', 'number', 'number']);

function do_solve() {
    var out = $("#fc_solve_output");

    // Clear to get a fresh solution.
    // out.val("");
    out.text("");

    // TODO : prevent memory leaks.
    // TODO : add support for (more) presets.
    // TODO : more robust error-handling / check for errors.
    var obj = freecell_solver_user_alloc();

    var preset_ret = freecell_solver_user_cmd_line_read_cmd_line_preset(obj, 'as', 0, 0, 0, null);

    // Removed for debugging purposes.
    // alert("preset_ret = " + preset_ret);

    var solve_err_code = freecell_solver_user_solve_board(
        obj, $("#stdin").val()
    );

    // 128 bytes are enough to hold a move.
    var move_buffer = malloc(128);

    var get_state_str = function () {
        return freecell_solver_user_current_state_as_string(obj, 1, 0, 1);
    };

    var my_append = function (str) {
        out.append(escapeHtml(str));
    };

    (function () {
        var state_as_string = get_state_str();
        my_append ( state_as_string + "\n\n");
    })();

    while ((move_ret_code = freecell_solver_user_get_next_move(obj, move_buffer)) == 0) {
        var state_as_string = freecell_solver_user_current_state_as_string(obj, 1, 0, 1);
        var move_as_string = freecell_solver_user_move_ptr_to_string_w_state(obj, move_buffer, 0);

        my_append(move_as_string + "\n\n" + state_as_string + "\n\n");
    }

    return;
}

</script>
  </body>
</html>
